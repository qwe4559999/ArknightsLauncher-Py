name: Build and Release

on:
  workflow_dispatch:  # 允许在 GitHub 网页上手动点击按钮触发打包
  push:
    tags:
      - 'v*'  # 当推送类似 v1.0.0 的标签时，自动触发打包和发布

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest

    permissions:
      contents: write  # 允许操作 Release 写入权限

    steps:
      - name: 检出代码 (Checkout code)
        uses: actions/checkout@v4

      - name: 设置 Python 环境 (Set up Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # 保持稳定的高版本

      - name: 安装依赖 (Install dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: 还原拆分的大型资源文件 (Reconstruct large resource files)
        shell: bash
        run: |
          python -c "
          import glob
          def m(t):
              parts = sorted(glob.glob(t + '.part*'))
              if not parts: return
              with open(t, 'wb') as outfile:
                  for part in parts:
                      with open(part, 'rb') as infile: outfile.write(infile.read())
              print('Merged', t)
          m('resources/ArknightsGame.zip')
          m('resources/Payload_B/BLPlatform64/BLWebBrowser/libcef.dll')
          "

      - name: 运行 PyInstaller 打包 (Build Executable)
        run: |
          pyinstaller --noconsole --onefile --add-data "resources;resources" --icon "resources/Icons/ArknightsLauncher.ico" main.py -y -n "ArknightsLauncher-Py-StandAlone"

      - name: 自动发布到 GitHub Release (Publish Release)
        # 只在有 tag 时才执行发布操作
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/ArknightsLauncher-Py-StandAlone.exe
          draft: false
          prerelease: false
          generate_release_notes: true # 自动生成基于 Commit 的更新日志
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
